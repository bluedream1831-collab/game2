<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç©¶æ¥µé€²åŒ–é›»å­å¯µç‰© v4.2 (å®Œç¾ä¿®å¾©ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #87CEEB;
            --pet-color: #fca5a5;
        }

        body {
            margin: 0; overflow: hidden;
            background-color: var(--bg-color);
            background-size: cover; background-position: center;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            user-select: none; transition: background 0.5s;
            touch-action: none; -webkit-tap-highlight-color: transparent;
        }

        /* èƒŒæ™¯ä¸»é¡Œ */
        body.bg-default { background-color: #87CEEB; }
        body.bg-forest { background: linear-gradient(to bottom, #87CEEB, #2ecc71); }
        body.bg-space { background: radial-gradient(circle, #2c3e50, #000); color: white; }
        body.bg-candy { background: radial-gradient(circle, #ffeaa7, #fab1a0); }

        /* --- å¯µç‰©æ§‹é€  --- */
        #pet-container { position: absolute; width: 100px; height: 120px; transition: 0.5s; z-index: 10; cursor: pointer; }
        .pet-visual-group { width: 100%; height: 100%; position: relative; transition: transform 0.2s; }
        
        .pet-hat { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); font-size: 40px; z-index: 20; text-shadow: 0 2px 5px rgba(0,0,0,0.2); pointer-events: none; }
        .pet-body { position: absolute; width: 60px; height: 50px; background-color: var(--pet-color); bottom: 25px; left: 20px; border-radius: 20px; box-shadow: inset -5px -5px rgba(0,0,0,0.15); z-index: 2; transition: all 0.5s; }
        .pet-head { position: absolute; font-size: 55px; top: -5px; left: 50%; transform: translateX(-50%); z-index: 10; text-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .limb { position: absolute; width: 12px; height: 25px; background: var(--pet-color); border-radius: 10px; transition: all 0.5s; box-shadow: inset -2px 0 rgba(0,0,0,0.15); }
        .arm { top: 55px; height: 20px; z-index: 3; } .arm.left { left: 15px; transform: rotate(20deg); } .arm.right { right: 15px; transform: rotate(-20deg); }
        .leg { bottom: 5px; height: 25px; z-index: 1; } .leg.left { left: 25px; } .leg.right { right: 25px; }
        .ear, .tail, .wing, .antenna { display: none; position: absolute; background: var(--pet-color); transition: all 0.5s; }
        
        /* ç¨®æ—ç‰¹å¾µ */
        [data-type="robot"] .pet-body, [data-type="robot"] .limb { border-radius: 2px; }
        [data-type="robot"] .antenna { display: block; top: -20px; left: 48%; width: 4px; height: 20px; background: #555; z-index: 1; }
        [data-type="robot"] .antenna::after { content:''; position: absolute; top:-6px; left:-3px; width:10px; height:10px; background:red; border-radius:50%; animation: blink 1s infinite; }
        [data-type="cat"] .ear { display: block; top: -5px; width: 20px; height: 20px; z-index: 9; }
        [data-type="cat"] .ear.left { left: 5px; transform: rotate(-15deg); border-radius: 5px 20px 0 0; }
        [data-type="cat"] .ear.right { right: 5px; transform: rotate(15deg); border-radius: 20px 5px 0 0; }
        [data-type="cat"] .tail { display: block; bottom: 30px; right: -10px; width: 50px; height: 10px; border-radius: 10px; animation: tail 2s infinite; z-index: 0; }
        [data-type="dog"] .ear { display: block; top: 10px; width: 18px; height: 25px; background: rgba(0,0,0,0.2); z-index: 9; }
        [data-type="dog"] .ear.left { left: -5px; transform: rotate(10deg); border-radius: 0 0 10px 10px; }
        [data-type="dog"] .ear.right { right: -5px; transform: rotate(-10deg); border-radius: 0 0 10px 10px; }
        [data-type="dragon"] .wing { display: block; top: 25px; width: 35px; height: 20px; background: rgba(0,0,0,0.2); border-radius: 0 30px 0 30px; z-index: 0; animation: fly 0.5s infinite alternate; }
        [data-type="dragon"] .wing.left { left: -25px; transform: scaleX(-1); }
        [data-type="dragon"] .wing.right { right: -25px; }
        
        /* éš±è—è§’è‰²æ¨£å¼ */
        [data-type="ghost"] .pet-body, [data-type="ghost"] .limb { opacity: 0.6; }
        [data-type="unicorn"] .pet-head { filter: drop-shadow(0 0 8px gold); }

        @keyframes blink { 50% { opacity: 0.3; } }
        @keyframes tail { 0%,100% { transform: rotate(-45deg); } 50% { transform: rotate(-25deg); } }
        @keyframes fly { to { transform: translateY(-8px); } }
        @keyframes egg-wobble { 0%,100%{transform:translateX(-50%) rotate(0)} 25%{transform:translateX(-50%) rotate(-5deg)} 75%{transform:translateX(-50%) rotate(5deg)} }
        .is-egg .pet-body, .is-egg .limb, .is-egg .ear, .is-egg .tail, .is-egg .wing, .is-egg .antenna, .is-egg .pet-hat { display: none !important; }
        .is-egg .pet-head { font-size: 80px; top: 20px; animation: egg-wobble 2s infinite; }

        /* UI */
        .hud-top { position: fixed; top: 15px; left: 15px; background: rgba(255,255,255,0.9); padding: 10px 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; z-index: 100; min-width: 130px; color:#333; }
        .xp-bar { height: 6px; background: #ddd; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .xp-fill { height: 100%; background: #f1c40f; width: 0%; transition: width 0.3s; }
        
        .hud-bottom { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 420px; background: rgba(255,255,255,0.95); border-radius: 25px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 100; display: flex; flex-direction: column; gap: 8px; }
        .bars { display: flex; gap: 10px; margin-bottom: 5px; }
        .bar-wrap { flex: 1; text-align: center; }
        .bar-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 2px; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.5s; }
        
        .btn-group { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
        button { border: none; background: #f0f0f0; padding: 10px 10px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; border: 1px solid #ccc; font-size: 13px; display: flex; align-items: center; gap: 3px; color:#333; }
        button:hover { background: #e0e0e0; transform: translateY(-2px); }
        .btn-shop { background: #fff0f6; border-color: #ffadd2; color: #c41d7f; }
        .btn-achieve { background: #fffbe6; border-color: #ffe58f; color: #d48806; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 20px; border-radius: 20px; text-align: left; max-width: 350px; width: 90%; max-height: 85vh; overflow-y: auto; position: relative; animation: popIn 0.3s; color:#333; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .tab-group { display: flex; border-bottom: 2px solid #eee; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: none; border: none; padding: 10px; color: #999; cursor: pointer; border-bottom: 3px solid transparent; font-size: 14px; }
        .tab-btn.active { color: #333; font-weight: bold; border-bottom-color: #333; }
        .tab-content { display: none; } .tab-content.active { display: block; }

        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .shop-item { border: 1px solid #eee; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; }
        .shop-item:hover { background: #f9f9f9; }
        .shop-item.owned { background: #e6fffa; border-color: #38b2ac; }
        .shop-item.equipped { background: #fffbe6; border-color: #f5a623; border-width: 2px; }
        .item-icon { font-size: 32px; display: block; }
        .item-badge { position: absolute; top: 5px; right: 5px; font-size: 10px; background: #38b2ac; color: white; padding: 2px 5px; border-radius: 5px; }

        /* æˆå°± */
        .ach-item { display: flex; align-items: center; background: #f8f9fa; border: 1px solid #eee; margin-bottom: 8px; padding: 10px; border-radius: 10px; opacity: 0.6; }
        .ach-item.unlocked { opacity: 1; border-color: #ffd700; background: #fffdf0; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.2); }
        .ach-icon { font-size: 30px; margin-right: 10px; }
        .ach-info { flex: 1; }
        .ach-title { font-weight: bold; font-size: 14px; }
        .ach-desc { font-size: 12px; color: #666; }
        .ach-reward { font-size: 11px; color: #e74c3c; font-weight: bold; }

        /* å…¶ä»– */
        .float-text { position: absolute; font-weight: bold; font-size: 20px; pointer-events: none; z-index: 200; animation: floatUp 1s forwards; text-shadow: 1px 1px 0 #fff; }
        @keyframes floatUp { to { opacity: 0; transform: translateY(-60px); } }
        #bubble { position: absolute; top: -75px; left: 50%; transform: translateX(-50%); background: white; padding: 5px 12px; border-radius: 15px; border: 2px solid #333; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; font-weight: bold; z-index: 20; color:black; }
        .particle { position: fixed; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; animation: p-fall 1s forwards; z-index: 500; }
        @keyframes p-fall { to { transform: translate(var(--tx), var(--ty)); opacity: 0; } }
        .poop { position: absolute; font-size: 30px; cursor: pointer; animation: drop 0.5s; z-index: 5; }
        @keyframes drop { from { transform: translateY(-50px); opacity: 0; } }
        
        .code-area { width: 100%; height: 60px; background: #333; color: #0f0; font-family: monospace; font-size: 12px; border-radius: 8px; padding: 10px; box-sizing: border-box; resize: none; }

        /* --- ä¿®æ­£å¾Œçš„æ­»äº¡ç•«é¢ --- */
        #death-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* æ·±é»‘èƒŒæ™¯ */
            color: white;
            z-index: 9999; /* æœ€é«˜å±¤ç´š */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        #death-screen h2 {
            margin: 20px 0;
            font-size: 32px;
            text-shadow: 0 0 10px red;
        }
    </style>
</head>
<body class="bg-default">

    <!-- é ‚éƒ¨è³‡è¨Š HUD -->
    <div class="hud-top">
        <div>ğŸ’° <span id="money">0</span></div>
        <div style="font-size:12px; margin-top:2px;">Lv.<span id="lvl">0</span> <span id="type-name">è›‹</span></div>
        <div class="xp-bar"><div id="xp-fill" class="xp-fill"></div></div>
    </div>

    <!-- å¯µç‰©æœ¬é«” -->
    <div id="pet-container" onclick="interact()">
        <div id="bubble">...</div>
        <div class="pet-visual-group" id="pet-group" data-type="egg">
            <div class="pet-hat" id="pet-hat"></div>
            <div class="pet-head" id="pet-head">ğŸ¥š</div>
            <div class="antenna"></div>
            <div class="ear left"></div> <div class="ear right"></div>
            <div class="wing left"></div> <div class="wing right"></div>
            <div class="tail"></div>
            <div class="pet-body"></div>
            <div class="limb arm left"></div> <div class="limb arm right"></div>
            <div class="limb leg left"></div> <div class="limb leg right"></div>
        </div>
    </div>

    <!-- ä¸‹æ–¹æ§åˆ¶ HUD -->
    <div class="hud-bottom">
        <div class="bars">
            <div class="bar-wrap"><div style="font-size:12px">é£½é£Ÿ</div><div class="bar-bg"><div id="bar-hunger" class="bar-fill" style="background:#ff7675;"></div></div></div>
            <div class="bar-wrap"><div style="font-size:12px">å¿ƒæƒ…</div><div class="bar-bg"><div id="bar-fun" class="bar-fill" style="background:#74b9ff;"></div></div></div>
            <div class="bar-wrap"><div style="font-size:12px">å¥åº·</div><div class="bar-bg"><div id="bar-health" class="bar-fill" style="background:#55efc4;"></div></div></div>
        </div>
        <div class="btn-group">
            <button onclick="feed()">ğŸ— é¤µé£Ÿ</button>
            <button onclick="openGame()" style="background:#fef3c7; border-color:#f59e0b;">ğŸ® ç©è€</button>
            <!-- æ–°å¢ç¡è¦ºæŒ‰éˆ• -->
            <button id="btn-sleep" onclick="toggleSleep()">ğŸ’¡ ç¡è¦º</button>
            <button onclick="work()">ğŸ’¼ æ‰“å·¥</button>
            <button onclick="openShop()" class="btn-shop">ğŸ›’ å•†åº—</button>
            <button onclick="cleanAll()">ğŸ§¹ æƒåœ°</button>
            <button onclick="changePet()">ğŸ”„ æ›è§’</button>
            <button onclick="openAchieve()" class="btn-achieve">ğŸ† æˆå°±</button>
            <button onclick="openSettings()" style="background:#e2e8f0;">âš™ï¸</button>
        </div>
    </div>

    <!-- å•†åº—è¦–çª— -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>æ™‚å°šå•†åº—è¡—</h3><span onclick="closeModal('shopModal')" style="cursor:pointer;font-size:20px;">âœ•</span>
            </div>
            <div style="margin-bottom:10px; font-size:14px; color:#666;">æŒæœ‰: ğŸ’°<span id="shop-money">0</span></div>
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchTab('tab-buy',this)">ğŸ›’ é£¾å“</button>
                <button class="tab-btn" onclick="switchTab('tab-wall',this)">ğŸ–¼ï¸ å£ç´™</button>
                <button class="tab-btn" onclick="switchTab('tab-inv',this)">ğŸ’ èƒŒåŒ…</button>
            </div>
            <div id="tab-buy" class="tab-content active"><div class="shop-grid" id="shop-list-gear"></div></div>
            <div id="tab-wall" class="tab-content"><div class="shop-grid" id="shop-list-wall"></div></div>
            <div id="tab-inv" class="tab-content">
                <div class="shop-grid" id="inv-list"></div>
                <button onclick="unequip()" style="width:100%; margin-top:15px; justify-content:center;">ğŸš« å¸ä¸‹è£å‚™</button>
            </div>
        </div>
    </div>

    <!-- æˆå°±è¦–çª— -->
    <div class="modal" id="achModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ† æˆå°±ç³»çµ±</h3><span onclick="closeModal('achModal')" style="cursor:pointer;font-size:20px;">âœ•</span>
            </div>
            <p style="font-size:12px; color:#666; margin-bottom:15px;">è§£é–æˆå°±å¯ä»¥ç²å¾—éš±è—è§’è‰²å–”ï¼</p>
            <div id="ach-list"></div>
        </div>
    </div>

    <!-- éŠæˆ²è¦–çª— -->
    <div class="modal" id="gameModal">
        <div class="modal-content" style="text-align:center;">
            <h3>çŒœæ‹³å°æ±º</h3>
            <div style="font-size:24px; font-weight:bold; margin:15px 0;" id="game-result">æº–å‚™...</div>
            <div style="display:flex; justify-content:space-around;">
                <button onclick="playRPS('r')" style="font-size:30px; width:60px;">âœŠ</button>
                <button onclick="playRPS('p')" style="font-size:30px; width:60px;">ğŸ–ï¸</button>
                <button onclick="playRPS('s')" style="font-size:30px; width:60px;">âœŒï¸</button>
            </div>
            <button onclick="closeModal('gameModal')" style="width:100%; margin-top:15px;">é—œé–‰</button>
        </div>
    </div>

    <!-- è¨­å®šè¦–çª— -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>âš™ï¸ ç³»çµ±</h3><span onclick="closeModal('settingsModal')" style="cursor:pointer;font-size:20px;">âœ•</span>
            </div>
            <a href="https://vocus.cc/user/@WUCJ" target="_blank" style="display:block; background:#333; color:white; padding:10px; border-radius:8px; text-decoration:none; text-align:center; margin:15px 0; font-weight:bold;">âœï¸ è¿½è¹¤ä½œè€… WUCJ</a>
            <p><b>åŒ¯å‡ºå­˜æª”</b></p><textarea id="export-area" class="code-area" readonly onclick="this.select()"></textarea>
            <p><b>åŒ¯å…¥å­˜æª”</b></p><textarea id="import-area" class="code-area"></textarea>
            <button onclick="loadSaveCode()" style="width:100%; margin-top:10px; background:#ff7675; color:white;">ğŸ“¥ è®€å–</button>
            <div style="margin-top:15px; font-size:12px; color:#999; text-align:center;">v4.2 ä¿®å¾©ç‰ˆ | å­˜æª”æ–¼æœ¬åœ°</div>
        </div>
    </div>

    <!-- æ­»äº¡ç•«é¢ -->
    <div id="death-screen">
        <div style="font-size:80px">ğŸª¦</div>
        <h2>å¯µç‰©æ­»æ‰äº†...</h2>
        <button onclick="resetGame()" style="font-size:20px; padding:15px 30px; margin-top:20px; cursor:pointer;">å†é¤Šä¸€éš»</button>
    </div>

<script>
    // --- éŠæˆ²è³‡æ–™ ---
    const PETS = [
        { id: 'dog', name: 'æŸ´æŸ´', emoji: 'ğŸ¶', color: '#eab308' },
        { id: 'cat', name: 'å–µçš‡', emoji: 'ğŸ±', color: '#f5f5f5' },
        { id: 'rabbit', name: 'å…”å…”', emoji: 'ğŸ°', color: '#ffb7b2' },
        { id: 'robot', name: 'æ©Ÿå™¨äºº', emoji: 'ğŸ¤–', color: '#94a3b8' },
        { id: 'dragon', name: 'å™´ç«é¾', emoji: 'ğŸ²', color: '#ef4444' },
        { id: 'ghost', name: 'å¹½éˆ', emoji: 'ğŸ‘»', color: '#a29bfe', hidden: true },
        { id: 'unicorn', name: 'ç¨è§’ç¸', emoji: 'ğŸ¦„', color: '#ffeaa7', hidden: true }
    ];

    const ITEMS = [
        { id: 'potion_hp', name: 'è¬èƒ½è—¥', icon: 'ğŸ’Š', price: 100, type: 'consumable' },
        { id: 'hat_bow', name: 'è´è¶çµ', icon: 'ğŸ€', price: 50, type: 'gear' },
        { id: 'hat_crown', name: 'çš‡å† ', icon: 'ğŸ‘‘', price: 200, type: 'gear' },
        { id: 'hat_sunglasses', name: 'å¢¨é¡', icon: 'ğŸ•¶ï¸', price: 60, type: 'gear' },
        { id: 'hat_top', name: 'ç´³å£«å¸½', icon: 'ğŸ©', price: 120, type: 'gear' },
        { id: 'wall_forest', name: 'æ£®æ—å£ç´™', icon: 'ğŸŒ²', price: 150, type: 'wall', css: 'bg-forest' },
        { id: 'wall_space', name: 'å®‡å®™å£ç´™', icon: 'ğŸŒŒ', price: 300, type: 'wall', css: 'bg-space' },
        { id: 'wall_candy', name: 'ç³–æœå£ç´™', icon: 'ğŸ¬', price: 150, type: 'wall', css: 'bg-candy' }
    ];

    const ACHIEVEMENTS = [
        { id: 'clean_10', title: 'éŸå±å¤§å¸«', desc: 'æ¸…ç† 10 æ¬¡ä¾¿ä¾¿', target: 10, stat: 'poopCount', reward: 'ghost', rewardText: 'è§£é–: å¹½éˆ' },
        { id: 'rich_500', title: 'å¤§å¯Œç¿', desc: 'æŒæœ‰é‡‘éŒ¢è¶…é $500', target: 500, stat: 'maxMoney', reward: 'unicorn', rewardText: 'è§£é–: ç¨è§’ç¸' },
        { id: 'fashion_3', title: 'æ™‚å°šé”äºº', desc: 'æ“æœ‰ 3 ä»¶ä»¥ä¸Šè£å‚™', target: 3, stat: 'gearCount', reward: 'money', rewardText: 'çå‹µ: $200' }
    ];

    let state = {
        typeIdx: 0, level: 0, xp: 0, money: 100,
        hunger: 80, fun: 80, health: 100,
        x: window.innerWidth/2, y: window.innerHeight/2,
        isSleeping: false, isWorking: false, isDead: false,
        inventory: [], equipped: null, bg: 'bg-default',
        lastLogin: null,
        stats: { poopCount: 0, maxMoney: 100, gearCount: 0 },
        unlockedAch: []
    };

    // --- éŸ³æ•ˆç³»çµ± ---
    const AudioContext = window.AudioContext || window.webkitAudioContext; let audioCtx;
    function playSound(t) {
        if(!audioCtx) audioCtx = new AudioContext(); if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain(), n=audioCtx.currentTime; o.connect(g); g.connect(audioCtx.destination);
        if(t==='jump'){o.freq(400,n);o.freqTo(800,n+0.1);g.vol(0.1,n);g.volTo(0.01,n+0.1);o.start(n);o.stop(n+0.1);}
        else if(t==='buy'){o.type='sine';o.freq(600,n);o.freqTo(1200,n+0.1);g.vol(0.1,n);g.volTo(0.01,n+0.3);o.start(n);o.stop(n+0.3);}
        else if(t==='win'){o.type='triangle';o.freq(500,n);o.freq(1000,n+0.2);g.vol(0.1,n);g.volTo(0.01,n+0.4);o.start(n);o.stop(n+0.4);}
        else if(t==='lose'){o.type='sawtooth';o.freq(300,n);o.freqTo(50,n+0.3);g.vol(0.1,n);g.volTo(0.01,n+0.3);o.start(n);o.stop(n+0.3);}
    }
    AudioNode.prototype.freq = function(v,t){this.frequency.setValueAtTime(v,t)};
    AudioNode.prototype.freqTo = function(v,t){this.frequency.linearRampToValueAtTime(v,t)};
    AudioNode.prototype.vol = function(v,t){this.gain.setValueAtTime(v,t)};
    AudioNode.prototype.volTo = function(v,t){this.gain.linearRampToValueAtTime(v,t)};

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function init() {
        loadGame();
        checkDailyLogin();
        applyBackground();
        updateUI(); updateVisuals();
        setInterval(loop, 1000); setInterval(aiMove, 3000); setInterval(maybePoop, 5000);
    }

    function checkDailyLogin() {
        if(state.isDead) return;
        const today = new Date().toDateString();
        if (state.lastLogin !== today && state.level > 0) {
            state.lastLogin = today;
            state.money += 200;
            setTimeout(()=>alert("ğŸ“… æ¯æ—¥ç™»å…¥çå‹µï¼\nç²å¾— $200"), 500);
            playSound('win');
        }
        checkStats();
    }

    function checkStats() {
        state.stats.maxMoney = Math.max(state.stats.maxMoney, state.money);
        state.stats.gearCount = state.inventory.filter(id => ITEMS.find(i=>i.id===id)?.type==='gear').length;
        
        ACHIEVEMENTS.forEach(ach => {
            if (!state.unlockedAch.includes(ach.id)) {
                if (state.stats[ach.stat] >= ach.target) {
                    unlockAchievement(ach);
                }
            }
        });
    }

    function unlockAchievement(ach) {
        state.unlockedAch.push(ach.id);
        playSound('win');
        setTimeout(()=>alert(`ğŸ† é”æˆæˆå°±ï¼š${ach.title}ï¼\n${ach.rewardText}`), 200);
        if(ach.reward === 'money') state.money += 200;
        saveGame();
    }

    function loop() {
        if(state.isDead) return;
        if(state.level===0) state.xp+=3;
        else {
            if(!state.isSleeping) { state.hunger-=1.5; state.fun-=1; if(state.hunger<20||state.fun<20) state.health-=2; else if(state.hunger>80&&state.fun>80) state.health+=1; }
            else { state.hunger-=0.5; state.health+=2; }
        }
        state.hunger=Math.max(0,Math.min(100,state.hunger)); state.fun=Math.max(0,Math.min(100,state.fun)); state.health=Math.max(0,Math.min(100,state.health));
        if(state.health<=0) die();
        checkLevelUp(); checkStats(); updateUI(); saveGame();
    }

    function checkLevelUp(){
        if(state.level<2 && state.xp >= (state.level===0?100:300)){
            state.level++; state.xp=0; playSound('win');
            explodeParticles(window.innerWidth/2,window.innerHeight/2,20); // æ¢å¾©ç‰¹æ•ˆ
            showFloatText("é€²åŒ–!","#ffd700"); updateVisuals();
        }
    }

    function interact() {
        if(state.isDead||state.isSleeping) return;
        document.getElementById('pet-container').style.transform="scale(1.2)"; setTimeout(()=>updateVisuals(),150);
        if(state.level===0) { state.xp+=5; showFloatText("æ–æ™ƒ...","#fff"); playSound('jump'); return; }
        state.fun=Math.min(100,state.fun+5); state.xp+=2; playSound('jump'); showFloatText("â¤ï¸","#ff7675"); updateUI();
    }

    function feed() {
        if(state.level===0) return say("è›‹é‚„ä¸èƒ½åƒ");
        if(state.money<15) return say("æ²’éŒ¢");
        state.money-=15; state.hunger=Math.min(100,state.hunger+40);
        playSound('buy'); showFloatText("å¥½åƒ!","#55efc4"); updateUI();
    }

    function work() {
        if(state.level===0||state.isWorking) return;
        state.isWorking=true; say("æ‰“å·¥...");
        document.getElementById('pet-container').style.left="120%";
        setTimeout(()=>{
            state.isWorking=false; state.money+=60; state.hunger-=20; state.fun-=20;
            state.x=window.innerWidth/2; updatePos();
            playSound('win'); showFloatText("+$60","#f1c40f"); checkStats(); updateUI();
        },3000);
    }

    // --- è£œå›ç¼ºå¤±çš„ AI ç§»å‹•å‡½æ•¸ ---
    function aiMove() {
        if(state.isDead || state.isSleeping || state.isWorking || state.level === 0) return;
        
        // éš¨æ©Ÿç§»å‹•é‚è¼¯
        const moveX = (Math.random() - 0.5) * 150;
        const moveY = (Math.random() - 0.5) * 100;
        
        let newX = state.x + moveX;
        let newY = state.y + moveY;

        // é‚Šç•Œæª¢æŸ¥
        newX = Math.max(50, Math.min(window.innerWidth - 50, newX));
        newY = Math.max(100, Math.min(window.innerHeight - 150, newY));

        state.x = newX;
        state.y = newY;
        
        updatePos();
        
        // éš¨æ©Ÿè½‰å‘æ•ˆæœ (ç°¡å–®é€é ScaleX ç¿»è½‰)
        const petGroup = document.getElementById('pet-group');
        if(moveX < 0) petGroup.style.transform = "scaleX(-1)";
        else petGroup.style.transform = "scaleX(1)";
    }

    // --- è£œå›ç²’å­ç‰¹æ•ˆ ---
    function explodeParticles(x, y, count) {
        const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
        for(let i=0; i<count; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            
            // éš¨æ©Ÿæ•£é–‹æ–¹å‘
            const angle = Math.random() * Math.PI * 2;
            const dist = 50 + Math.random() * 100;
            const tx = Math.cos(angle) * dist;
            const ty = Math.sin(angle) * dist;
            
            p.style.setProperty('--tx', tx + 'px');
            p.style.setProperty('--ty', ty + 'px');
            
            document.body.appendChild(p);
            setTimeout(()=>p.remove(), 1000);
        }
    }

    // --- å•†åº—ç³»çµ± ---
    function openShop() {
        if(state.level===0) return say("è›‹ä¸èƒ½è²·");
        document.getElementById('shop-money').innerText=state.money;
        renderShop(); document.getElementById('shopModal').style.display='flex';
    }
    function renderShop() {
        const render = (listId, typeFilter) => {
            const el = document.getElementById(listId); el.innerHTML='';
            ITEMS.filter(i=> typeFilter ? i.type===typeFilter : i.type!=='wall').forEach(i => {
                const owned = state.inventory.includes(i.id);
                const d = document.createElement('div');
                d.className = `shop-item ${owned && i.type!=='consumable' ? 'owned' : ''}`;
                d.onclick = () => buyItem(i.id);
                d.innerHTML = `<div class="item-icon">${i.icon}</div><div class="item-name">${i.name}</div><div class="item-price">$${i.price}</div>${owned&&i.type!=='consumable'?'<div class="item-badge">å·²æ“æœ‰</div>':''}`;
                el.appendChild(d);
            });
        };
        render('shop-list-gear', 'gear');
        render('shop-list-wall', 'wall');
        
        // èƒŒåŒ…
        const invEl = document.getElementById('inv-list'); invEl.innerHTML='';
        state.inventory.forEach(id => {
            const item = ITEMS.find(x=>x.id===id); if(!item) return;
            const isEq = state.equipped === id || state.bg === item.css;
            const d = document.createElement('div');
            d.className = `shop-item ${isEq?'equipped':''}`;
            d.onclick = () => useItem(id);
            d.innerHTML = `<div class="item-icon">${item.icon}</div><div class="item-name">${item.name}</div>${isEq?'<div class="item-badge" style="background:#f5a623">ä½¿ç”¨ä¸­</div>':''}`;
            invEl.appendChild(d);
        });
    }

    function buyItem(id) {
        const item = ITEMS.find(x=>x.id===id);
        if(state.money < item.price) return alert("éŒ¢ä¸å¤ ");
        if(item.type!=='consumable' && state.inventory.includes(id)) return alert("å·²æ“æœ‰");
        state.money -= item.price; playSound('buy'); document.getElementById('shop-money').innerText=state.money;
        
        if(item.type==='consumable') {
            if(id==='potion_hp') { state.health=100; alert("å¥åº·å·²æ¢å¾©!"); }
        } else {
            state.inventory.push(id); alert("å·²è³¼è²·! è«‹è‡³èƒŒåŒ…ä½¿ç”¨");
        }
        checkStats(); renderShop(); saveGame(); updateUI();
    }

    function useItem(id) {
        const item = ITEMS.find(x=>x.id===id);
        if(item.type==='gear') { state.equipped=id; say("æ›è£!"); }
        else if(item.type==='wall') { state.bg=item.css; applyBackground(); say("æ›å£ç´™!"); }
        updateVisuals(); renderShop(); saveGame();
    }
    function unequip() { state.equipped=null; updateVisuals(); renderShop(); saveGame(); }

    function applyBackground() { document.body.className = state.bg || 'bg-default'; }

    // --- æˆå°±ç³»çµ± ---
    function openAchieve() {
        const el = document.getElementById('ach-list'); el.innerHTML='';
        ACHIEVEMENTS.forEach(ach => {
            const unlocked = state.unlockedAch.includes(ach.id);
            const d = document.createElement('div');
            d.className = `ach-item ${unlocked?'unlocked':''}`;
            d.innerHTML = `<div class="ach-icon">${unlocked?'ğŸ†':'ğŸ”’'}</div><div class="ach-info"><div class="ach-title">${ach.title}</div><div class="ach-desc">${ach.desc}</div><div class="ach-reward">${ach.rewardText}</div></div>`;
            el.appendChild(d);
        });
        document.getElementById('achModal').style.display='flex';
    }

    // --- éŠæˆ² ---
    function openGame(){if(state.level===0)return say("è›‹ä¸èƒ½ç©");document.getElementById('gameModal').style.display='flex';document.getElementById('game-result').innerText="è«‹å‡ºæ‹³";}
    function playRPS(u){
        const ai=['r','p','s'][Math.floor(Math.random()*3)];
        const m={r:'âœŠ',p:'ğŸ–ï¸',s:'âœŒï¸'};
        let res='lose'; if(u===ai)res='draw'; else if((u==='r'&&ai==='s')||(u==='p'&&ai==='r')||(u==='s'&&ai==='p'))res='win';
        const el=document.getElementById('game-result');
        if(res==='win'){state.money+=30;state.fun=Math.min(100,state.fun+20);state.xp+=10;el.innerText=`${m[ai]} ä½ è´äº†!`;el.style.color='green';playSound('win');}
        else if(res==='lose'){state.fun=Math.max(0,state.fun-10);el.innerText=`${m[ai]} ä½ è¼¸äº†`;el.style.color='red';playSound('lose');}
        else{el.innerText=`${m[ai]} å¹³æ‰‹`;el.style.color='#666';}
        checkStats(); updateUI();
    }

    // --- ç³»çµ± ---
    function updateVisuals(){
        const d=PETS[state.typeIdx]; document.documentElement.style.setProperty('--pet-color',d.color);
        const hat=document.getElementById('pet-hat');
        if(state.equipped&&state.level>0){ const i=ITEMS.find(x=>x.id===state.equipped); hat.innerText=i?i.icon:''; hat.style.display='block'; }
        else hat.style.display='none';
        
        const grp=document.getElementById('pet-group');
        if(state.level===0){ grp.setAttribute('data-type','egg'); document.getElementById('pet-head').textContent='ğŸ¥š'; document.getElementById('pet-container').classList.add('is-egg'); document.getElementById('type-name').innerText="ç¥ç§˜è›‹"; }
        else{ grp.setAttribute('data-type',d.id); document.getElementById('pet-head').textContent=d.emoji; document.getElementById('pet-container').classList.remove('is-egg'); document.getElementById('type-name').innerText=d.name; document.getElementById('pet-container').style.transform=state.level===2?'scale(1.3)':'scale(1)'; }
        updatePos();
    }
    
    function changePet(){
        if(state.level===0) return;
        let nextIdx = (state.typeIdx+1)%PETS.length;
        // è·³éæœªè§£é–çš„éš±è—è§’è‰²
        while(PETS[nextIdx].hidden) {
            const petId = PETS[nextIdx].id;
            const achId = ACHIEVEMENTS.find(a=>a.reward===petId)?.id;
            if(state.unlockedAch.includes(achId)) break; 
            nextIdx = (nextIdx+1)%PETS.length;
            if(nextIdx === state.typeIdx) return;
        }
        state.typeIdx = nextIdx;
        updateVisuals(); playSound('jump');
    }

    function maybePoop(){
        if(state.level>0&&!state.isSleeping&&!state.isWorking&&Math.random()<0.1){
            const p=document.createElement('div'); p.className='poop'; p.textContent='ğŸ’©';
            p.style.left=(state.x+Math.random()*40-20)+'px'; p.style.top=(state.y+Math.random()*40-20)+'px';
            p.onclick=function(){this.remove();state.money+=2;state.stats.poopCount++;playSound('jump');checkStats();updateUI();};
            document.body.appendChild(p);
        }
    }
    function cleanAll(){ document.querySelectorAll('.poop').forEach(e=>{e.remove();state.stats.poopCount++;}); playSound('buy'); checkStats(); updateUI(); }
    
    function die(){
        state.isDead=true;
        document.getElementById('death-screen').style.display='flex';
        playSound('lose');
        localStorage.removeItem('petMaster');
    }
    function resetGame(){
        if(confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ")){
            localStorage.removeItem('petMaster');
            location.reload();
        }
    }
    
    function updatePos(){document.getElementById('pet-container').style.left=(state.x-50)+'px';document.getElementById('pet-container').style.top=(state.y-60)+'px';}
    function showFloatText(t,c){const d=document.createElement('div');d.className='float-text';d.textContent=t;d.style.color=c;d.style.left=state.x+'px';d.style.top=(state.y-50)+'px';document.body.appendChild(d);setTimeout(()=>d.remove(),1000);}
    function say(t){const b=document.getElementById('bubble');b.textContent=t;b.style.opacity=1;setTimeout(()=>b.style.opacity=0,2000);}
    function updateUI(){
        document.getElementById('money').textContent=state.money; document.getElementById('lvl').textContent=state.level;
        document.getElementById('bar-hunger').style.width=state.hunger+'%'; document.getElementById('bar-fun').style.width=state.fun+'%'; document.getElementById('bar-health').style.width=state.health+'%';
        document.getElementById('xp-fill').style.width=Math.min(100,(state.xp/(state.level===0?100:300))*100)+'%';
    }
    
    // å­˜æª”ç³»çµ±
    function saveGame(){localStorage.setItem('petMaster',JSON.stringify(state));}
    function loadGame(){
        const s=localStorage.getItem('petMaster');
        if(s){
            const l=JSON.parse(s);
            state={...state, ...l, inventory:l.inventory||[], stats:l.stats||{poopCount:0,maxMoney:0,gearCount:0}, unlockedAch:l.unlockedAch||[], isDead:false};
        }
    }
    function openSettings(){document.getElementById('settingsModal').style.display='flex';document.getElementById('export-area').value=btoa(JSON.stringify(state));}
    function closeModal(id){document.getElementById(id).style.display='none';}
    function switchTab(id,btn){const p=btn.parentElement.parentElement;p.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));p.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));p.querySelector('#'+id).classList.add('active');btn.classList.add('active');}
    function loadSaveCode(){try{const d=JSON.parse(atob(document.getElementById("import-area").value));if(d.money!=undefined){state=d;saveGame();location.reload();}}catch(e){alert("ä»£ç¢¼ç„¡æ•ˆ");}}
    
    // ä¿®å¾©: ç¢ºä¿æŒ‰éˆ•é‚è¼¯æ­£ç¢º
    function toggleSleep(){
        state.isSleeping=!state.isSleeping;
        const btn = document.getElementById('btn-sleep');
        const container = document.getElementById('pet-container');
        
        if(state.isSleeping){
            container.style.filter="brightness(0.6)";
            btn.textContent="â˜€ï¸ èµ·åºŠ";
            say("Zzz...");
        }else{
            container.style.filter="none";
            btn.textContent="ğŸ’¡ ç¡è¦º";
            say("æ—©å®‰!");
        }
        updateUI();
    }

    init();
</script>
</body>
</html>
